# 🔬 物理实验报告助手

> **AI 驱动的物理实验数据分析与报告生成工具**

集数据分析、科学拟合、AI 辅助撰写于一体。基于 **Streamlit + 通义千问 (Qwen LLM)**

---

## 🚀 快速开始

### 安装（一条命令）

```bash
cd setup
python setup.py
```

详细说明请查看 [setup/SETUP_README.md](setup/SETUP_README.md)

### 启动应用

安装完成后自动启动，或访问：http://localhost:8501

---

## 🎯 核心特性

### 1. **四阶段工作流**
- 📸 **OCR 识别** - AI 视觉识别从实验记录中提取数据表
- 🔢 **数据分析与拟合** - 支持多种拟合模型、自动计算参数不确定度、生成可视化
- 🎯 **误差分析** - 对话式与 AI 讨论不确定度来源，使用偏导法（符号计算）
- ✍️ **AI 协作撰写** - 基于完整分析结果生成专业报告文段，遵循学术规范

### 2. **学术严谨的不确定度体系**
- ✅ 加权最小二乘法提升拟合精度
- ✅ 自动计算参数不确定度、加权 R²、χ² 等统计量
- ✅ 符合 GB/T 15000.2 物理量和单位标准
- ✅ 支持 A 类（统计）和 B 类（系统）不确定度分离评估
- ✅ 误差传播公式自动推导（偏导法）

### 3. **智能误差分析**
- 💬 对话式界面 - 与 AI 专家讨论实验误差来源
- 🔧 符号计算 - 使用 SymPy 自动计算偏导数
- 📊 贡献分析 - 可视化各变量对合成不确定度的贡献
- 📐 完整推导 - 自动生成 LaTeX 推导过程

### 4. **AI 安全约束**
- 禁止幻觉机制 - AI 仅基于提供的数据撰写
- 对话式规划 - 确保生成内容符合实验背景
- 片段化输出 - 报告分解为可独立使用的模块

### 5. **工程化报告输出**
- 一键生成 ZIP 包含：LaTeX 报告、数据表、图表、CSV 数据

---

## 📊 功能模块

### OCR 数据提取
- 支持多种图片格式（JPG、PNG、BMP）
- AI 视觉识别自动提取实验数据表
- 交互式编辑，支持数据确认和修正

### 数据分析引擎
- 支持 4 种拟合模型：线性拟合、对数拟合、幂律拟合、FFT 频谱分析
- 自动计算拟合参数的不确定度
- 加权最小二乘法处理非均匀误差
- 拟合质量指标：R²、χ² 等

### 误差分析引擎
- **对话式数据收集** - 与 AI 讨论实验误差来源
- **符号计算工具** - SymPy 驱动的偏导数自动计算
- **方法**：偏导法（快速精确，生成完整推导过程）
- **贡献分析** - 可视化各变量的误差贡献百分比
- **合理性校验** - 自动检测异常数据

### LLM 报告生成
- 基于阿里云通义千问模型，支持三种模型选择：
  - **Flash** - 快速 OCR 和原型设计（便宜）
  - **Max** - 高质量报告生成（均衡）
  - **Plus** - 深度物理分析和复杂推理（专业）
- 对话式规划和 AI 辅助撰写
- 自动融合误差分析结果
- 生成 LaTeX 格式报告

### 数据可视化
- matplotlib 绘制高质量图表
- Plotly 交互式可视化（误差贡献饼图）
- 支持误差棒、拟合曲线、参数展示

---

## 🛠️ 环境要求

- **Python 3.8+**
- **网络连接** - 用于下载依赖和访问 LLM API
- **阿里云账户** - 获取 DashScope API-Key（免费额度可用）

---

## 📚 文档导航

| 文件 | 说明 |
|------|------|
| **[setup/SETUP_README.md](setup/SETUP_README.md)** | ⚡ 快速安装指南和常见问题 |
| **[setup/setup.py](setup/setup.py)** | 🐍 推荐：跨平台脚本 |

---

## 💡 使用流程

1. **OCR 识别** - 上传实验记录图片，AI 自动提取数据表
2. **数据分析** - 选择拟合模型，查看结果和参数不确定度
3. **误差分析** - 与 AI 对话讨论误差来源，输入各量的不确定度，得到合成不确定度
4. **生成报告** - 基于完整分析结果与 AI 协作撰写专业实验报告

---

## 🧪 误差分析板块（使用方法）

1. **进入页面**：左侧导航选择「误差分析」。
2. **准备测量量**：在表单中为每个变量输入符号、数值、单位，以及 A 类/ B 类不确定度（移除了数字微调按钮，使用文本框便于批量粘贴）。
3. **对话澄清公式**：在对话框描述实验公式或提出问题；LLM 会规范化公式并在需要时引导补齐缺失参数。
4. **流式计算反馈**：LLM 以流式输出展示思考、工具调用（MCP 符号计算）、偏导数结果、贡献条形图，以及合成不确定度。
5. **深度思考**：选择 Plus 模型时自动启用深度思考（enable_thinking=true），其余模型走常规推理。
6. **传递到写作**：点击「传给写作AI」将计算结果与对话历史带入「LLM 协作」页，Act 阶段同样流式输出报告片段。

---

## 🏗️ 项目结构

```
Physics-Lab-Report-Assistant/
├── setup/                    # 📦 安装脚本和文档
├── app.py                    # 🎨 Streamlit 主应用（1538行）
├── analysis_module.py        # 📊 数据分析引擎（441行）
├── llm_integration.py        # 🤖 LLM 集成（469行）
├── uncertainty_calculator.py # 🎯 误差分析引擎（448行）
├── latex_generator.py        # 📄 LaTeX 生成（156行）
├── mcp_servers/              # 🔧 符号计算 MCP 服务
│   └── symbolic_math.py      # 符号微分、表达式化简
├── requirements.txt          # 依赖列表
└── README.md                 # 本文件
```

**核心文件说明**：
- `app.py` - 4个页面的 Streamlit 应用（OCR → 分析 → 误差 → 报告）
- `uncertainty_calculator.py` - 不确定度计算引擎（偏导法）
- `mcp_servers/symbolic_math.py` - 符号计算工具（SymPy 驱动）

---

## 🎓 误差分析详解

### 对话式数据收集
```
应用主动引导用户输入：
- "你的实验公式是什么？"
- "哪个变量的不确定度最大？"
- "这是 A 类（统计）还是 B 类（系统）误差？"
- "是否考虑了仪器精度和读数误差？"
```

### 自动计算流程
```
用户输入公式 + 测量数据
   ↓
SymPy 符号化偏导数计算（偏导法）
   ↓
贡献分析：哪个变量影响最大？
   ↓
改进建议：如何优先提高哪个变量的精度？
```

### 关键指标
- **合成不确定度** = √(ΣA类² + ΣB类²)
- **相对不确定度** = 合成不确定度 / 测量值
- **贡献度** = 单个变量贡献² / 总贡献²

## 🔧 配置

### API-Key 配置

1. 访问 https://dashscope.console.aliyun.com
2. 创建 API-Key（免费额度可用）
3. 运行脚本时输入，或在 `.env` 文件中配置：

```env
DASHSCOPE_API_KEY=your_api_key_here
ALIBABA_CLOUD_MODEL=qwen-flash  # 可选：选择模型
```

### 模型选择建议

| 场景 | 推荐模型 | 理由 |
|------|--------|------|
| 快速 OCR 提取 | Flash | ⚡⚡⚡ 最快，成本低 |
| 误差分析讨论 | Max | ⚡ 平衡性能和成本 |
| 深度物理推理 | Plus | 🧠 最强，支持深度思考 |
| 报告撰写 | Max | 💰 成本效益最优 |

---

## ❓ 常见问题

**Q: 误差分析需要什么输入？**
A: 需要：实验公式、各测量量的数值和不确定度（A类和B类）。应用会引导你一步步输入。

**Q: 偏导法适合哪些场景？**
A: 偏导法适合绝大多数实验，快速精确；若怀疑存在强非线性，可在外部使用数值模拟自行验证。

**Q: 如何评估数据的合理性？**
A: 相对不确定度应在 1%-20% 之间。过小（<1%）可能低估误差，过大（>50%）可能数据有问题。应用会自动提示。

**Q: 如何改进实验精度？**
A: 查看贡献分析，找出最大误差来源（通常贡献 >50%），优先改进该变量的测量方法或仪器。

**Q: 需要多长时间安装？**
A: 首次 5-10 分钟，之后每次启动 10 秒

**Q: 支持哪些系统？**
A: Windows、macOS、Linux

**Q: 可以离线使用吗？**
A: 数据分析和误差计算可以离线，报告生成需要网络

**更多问题？** 查看 [setup/SETUP_README.md](setup/SETUP_README.md)

---

## 🙏 致谢

- **Streamlit** - Web UI 框架
- **阿里云通义千问** - 大语言模型
- **Copilot** - 代码生成辅助

---

## 📖 使用示例

### 例子：单摆周期测量
```
1️⃣ OCR 识别
   上传实验记录图片 → AI 识别摆长 L、周期 T 的数据表

2️⃣ 数据分析
   进行线性回归分析 T² 与 L 的关系
   得到 g = 9.78 ± 0.12 m/s²

3️⃣ 误差分析
   对话框：
   - 输入公式：T = 2*pi*sqrt(L/g)
   - 摆长 L = 0.990 ± 0.005 m（尺度精度±0.5cm）
   - 周期 T = 2.00 ± 0.02 s（计时精度±0.01s）
   
   偏导计算结果：
   - L 的贡献：25.3%
   - T 的贡献：74.7% ← 主要误差来源
   
   改进建议：使用更精确的计时方法，相对误差减少一半

4️⃣ 生成报告
   自动生成包含完整误差分析的 LaTeX 报告
```

---

**版本**: 2.2 | **更新**: 2025年12月25日

**新增特性**（v2.2）：
- ✨ 误差分析与写作 Act 阶段全程流式输出
- 🧠 Plus 模型自动开启深度思考（enable_thinking）
- 📑 新增误差分析板块使用指南
- 🔧 优化MCP符号计算结果的对话化呈现
